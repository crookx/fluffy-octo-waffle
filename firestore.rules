rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check for Admin role
    function isAdmin() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'ADMIN';
    }

    // Users can read/write their own profile, Admins can read any profile
    match /users/{userId} {
      allow read: if request.auth.uid == userId || isAdmin();
      allow write: if request.auth.uid == userId;

      // Users can manage their own favorites list
      match /favorites/{listingId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
      
      // Users can manage their own saved searches
      match /savedSearches/{searchId} {
        allow read, write, delete: if request.auth.uid == userId;
      }
    }

    // Listings have granular access control
    match /listings/{listingId} {
      // Allow public read only for 'approved' listings.
      // Authenticated users can read their own listings regardless of status.
      allow get: if resource.data.status == 'approved' ||
                    (request.auth != null && (resource.data.ownerId == request.auth.uid || isAdmin()));
      
      // Admins can list all listings. Other users can only list approved ones.
      allow list: if isAdmin() || request.query.get('status') == 'approved';

      // Any authenticated user can create a listing.
      // We tie ownership via request.resource.data.ownerId.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;

      // Users can update their own listings, but cannot change the status.
      // Admins can update any listing, including status.
      allow update: if request.auth != null &&
                       ( (resource.data.ownerId == request.auth.uid && !('status' in request.resource.data)) || isAdmin() );

      // Users can delete their own listings. Admins can delete any.
      allow delete: if request.auth != null && (resource.data.ownerId == request.auth.uid || isAdmin());
    }

    // Evidence documents require ownership or admin privileges.
    match /evidence/{evidenceId} {
      // An owner or an admin can read evidence documents.
      allow read: if request.auth != null && (
        get(/databases/$(database)/documents/listings/$(resource.data.listingId)).data.ownerId == request.auth.uid || isAdmin()
      );

      // Only the owner of the listing can create evidence for it.
      allow create: if request.auth != null && request.resource.data.ownerId == request.auth.uid;
      
      // Deletion and updates are restricted to owner or admin.
      allow delete, update: if request.auth != null && (resource.data.ownerId == request.auth.uid || isAdmin());
    }
    
    // Conversations can be read/written by participants
    match /conversations/{conversationId} {
      // Participants can get/update their conversation, or list conversations they are in.
      allow get, update: if request.auth.uid in resource.data.participantIds;
      allow list: if request.auth.uid in request.query.get('participantIds');
      allow create: if request.auth.uid in request.resource.data.participantIds;
      
      // Messages subcollection
      match /messages/{messageId} {
        // Participants can read all messages in a conversation
        allow read: if get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid]);
        
        // Participants can only create messages as themselves
        allow create: if get(/databases/$(database)/documents/conversations/$(conversationId)).data.participantIds.hasAny([request.auth.uid])
                      && request.resource.data.senderId == request.auth.uid;
      }
    }

    // Admins can read and update contact messages.
    match /contactMessages/{messageId} {
      allow read, update: if isAdmin();
    }
    
    // Admins can read and update listing reports.
    match /listingReports/{reportId} {
      allow read, update: if isAdmin();
    }
  }
}
